<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Nest Chat</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      #chatMessages {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin: 10px 0;
        background-color: #f9f9f9;
      }
      #rooms {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        background-color: #f5f5f5;
      }
      #notice {
        border: 1px solid #ddd;
        height: 150px;
        overflow-y: auto;
        padding: 10px;
        margin: 10px 0;
        background-color: #f0f8ff;
      }
      input[type='text'] {
        padding: 5px;
        margin: 5px;
        width: 300px;
      }
      button {
        padding: 5px 10px;
        margin: 5px;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        background-color: white;
        border-radius: 3px;
      }
      .join-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: background-color 0.2s;
      }
      .join-btn:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
      }
      .join-btn.current-room {
        background-color: #28a745 !important;
        cursor: default !important;
      }
      .join-btn.current-room:hover {
        background-color: #28a745 !important;
        transform: none !important;
      }
      .room-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border: 1px solid #ddd;
        margin: 4px 0;
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .room-name {
        font-weight: bold;
        color: #333;
        flex-grow: 1;
      }
    </style>
  </head>
  <body>
    <h2>Simple Nest Chat</h2>

    <div>
      <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
      <div id="rooms">ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      <input type="text" id="roomName" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button onclick="createRoom()">ë°© ë§Œë“¤ê¸°</button>
    </div>

    <div>
      <h3>ë°© ì…ì¥</h3>
      <input
        type="text"
        id="nickname"
        placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
        value="user"
      />
      <input type="text" id="joinRoomName" placeholder="ì…ì¥í•  ë°© ì´ë¦„" />
      <button onclick="joinRoom()">ë°© ì…ì¥</button>
      <div id="currentRoom" style="margin-top: 10px; font-weight: bold"></div>
    </div>

    <div>
      <h3>ì±„íŒ…</h3>
      <div id="chatMessages"></div>
      <input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <button onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <div>
      <h2>ê³µì§€</h2>
      <div id="notice"></div>
    </div>
  </body>
  <!-- jquery code -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('http://localhost:3000');
    const roomSocket = io('http://localhost:3000/room');
    let currentRoom = null; // í˜„ì¬ ì…ì¥í•œ ë°© ì¶”ì 

    function sendMessage() {
      const message = $('#message').val();
      if (message.trim()) {
        socket.emit('message', message);
        $('#message').val('');
      }
    }

    function createRoom() {
      const roomName = $('#roomName').val();
      if (roomName.trim()) {
        roomSocket.emit('createRoom', {
          nickname: $('#nickname').val() || 'user',
          room: roomName,
        });
        $('#roomName').val('');
      }
    }

    function joinRoom() {
      const nickname = $('#nickname').val() || 'user';
      const roomName = $('#joinRoomName').val();

      if (roomName.trim()) {
        socket.emit('joinRoom', {
          nickname: nickname,
          room: roomName,
        });
        currentRoom = roomName;
        updateCurrentRoomDisplay(roomName, nickname);
        $('#joinRoomName').val('');
        updateRoomButtons(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      }
    }

    // ë°© ëª©ë¡ì—ì„œ í´ë¦­í•˜ì—¬ ì…ì¥í•˜ëŠ” í•¨ìˆ˜
    function joinRoomFromList(roomName) {
      const nickname = $('#nickname').val() || 'user';
      socket.emit('joinRoom', {
        nickname: nickname,
        room: roomName,
      });
      currentRoom = roomName;
      updateCurrentRoomDisplay(roomName, nickname);
      updateRoomButtons(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    }

    // í˜„ì¬ ë°© í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateCurrentRoomDisplay(roomName, nickname) {
      $('#currentRoom').html(`í˜„ì¬ ë°©: <span style="color: #007bff; font-weight: bold;">${roomName}</span> (${nickname})`);
    }

    // ë°© ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateRoomButtons() {
      // ëª¨ë“  join ë²„íŠ¼ì„ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•´ ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      roomSocket.emit('getRooms');
    }

    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    $('#message').keypress(function (e) {
      if (e.which === 13) {
        sendMessage();
      }
    });

    // Enter í‚¤ë¡œ ë°© ìƒì„±
    $('#roomName').keypress(function (e) {
      if (e.which === 13) {
        createRoom();
      }
    });

    // Enter í‚¤ë¡œ ë°© ì…ì¥
    $('#joinRoomName').keypress(function (e) {
      if (e.which === 13) {
        joinRoom();
      }
    });

    socket.on('connect', () => {
      console.log('Chat socket connected');
    });

    socket.on('message', (message) => {
      $('#chatMessages').append(`<div class="message">${message}</div>`);
      $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    });

    socket.on('notice', (data) => {
      $('#notice').append(
        `<div class="message" style="background-color: #e8f5e8;">${data.message}</div>`,
      );
      $('#notice').scrollTop($('#notice')[0].scrollHeight);
    });

    socket.on('joinedRoom', (data) => {
      $('#notice').append(
        `<div class="message" style="background-color: #d4edda; border: 1px solid #c3e6cb;">${data.message}</div>`,
      );
      $('#notice').scrollTop($('#notice')[0].scrollHeight);
    });

    roomSocket.on('connect', () => {
      console.log('Room socket connected');
      // ì—°ê²°ë˜ë©´ ë°© ëª©ë¡ ìš”ì²­
      roomSocket.emit('getRooms');
    });

    roomSocket.on('rooms', (rooms) => {
      console.log('Rooms received:', rooms);
      $('#rooms').html('');
      if (rooms.length === 0) {
        $('#rooms').html('<p>ì•„ì§ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
      } else {
        rooms.forEach((room) => {
          const isCurrentRoom = room === currentRoom;
          const buttonText = isCurrentRoom ? 'Current' : 'Join';
          const buttonClass = isCurrentRoom ? 'join-btn current-room' : 'join-btn';
          const buttonStyle = isCurrentRoom ? 'background-color: #28a745; cursor: default;' : '';
          const onclick = isCurrentRoom ? '' : `onclick="joinRoomFromList('${room}')"`;
          
          $('#rooms').append(
            `<div class="room-item">
              <span class="room-name">ğŸ“ ${room}</span>
              <button class="${buttonClass}" ${onclick} style="${buttonStyle}">
                ${buttonText}
              </button>
            </div>`,
          );
        });
      }
    });

    roomSocket.on('notice', (data) => {
      $('#notice').append(
        `<div class="message" style="background-color: #fff3cd;">${data.message}</div>`,
      );
      $('#notice').scrollTop($('#notice')[0].scrollHeight);
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°© ëª©ë¡ ìš”ì²­
    $(document).ready(function () {
      setTimeout(() => {
        if (roomSocket.connected) {
          roomSocket.emit('getRooms');
        }
      }, 1000);
    });
  </script>
</html>
