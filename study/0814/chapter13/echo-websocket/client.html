<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Client</title>
    <style>
      .message {
        width: 300px;
        color: #fff;
        background-color: purple;
        margin-top: 5px;
        padding: 10px;
        border-radius: 5px;
      }
      #messages {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Echo Client</h1>
    <textarea
      id="message"
      cols="50"
      rows="5"
      placeholder="메시지를 입력하세요..."
    ></textarea>
    <br />
    <!-- 버튼 -->
    <button onclick="sendMessage()">전송</button>
    <button onclick="WebSocketClose()">종료</button>

    <!-- 메시지를 표시할 영역 -->
    <div id="messages"></div>

    <script>
      let ws = null;

      function connectWebSocket() {
        try {
          ws = new WebSocket("ws://localhost:3000");

          ws.onopen = function () {
            console.log("클라이언트 접속 완료");
            addMessage("연결됨: WebSocket 서버에 접속했습니다.", "success");
          };

          ws.onmessage = function (event) {
            let message = event.data.replace(/(\r\n|\n|\r)/g, "<br />");
            addMessage(message, "received");
          };

          ws.onclose = function (e) {
            console.log("종료");
            addMessage("연결 종료: WebSocket 연결이 종료되었습니다.", "error");
          };

          ws.onerror = function (error) {
            console.error("WebSocket 오류:", error);
            addMessage(
              "오류: WebSocket 연결에 실패했습니다. 서버가 실행중인지 확인하세요.",
              "error"
            );
          };
        } catch (error) {
          console.error("WebSocket 생성 오류:", error);
          addMessage("오류: WebSocket을 생성할 수 없습니다.", "error");
        }
      }

      function addMessage(message, type = "message") {
        let el = document.createElement("div");
        el.className =
          type === "success"
            ? "message success"
            : type === "error"
            ? "message error"
            : "message";
        el.innerHTML = message;

        if (type === "success") {
          el.style.backgroundColor = "green";
        } else if (type === "error") {
          el.style.backgroundColor = "red";
        }

        document.getElementById("messages").appendChild(el);
        // 스크롤을 맨 아래로
        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      }

      function sendMessage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("오류: WebSocket이 연결되지 않았습니다.", "error");
          return;
        }

        const messageInput = document.getElementById("message");
        const message = messageInput.value.trim();

        if (message) {
          ws.send(message);
          addMessage(`보냄: ${message}`, "sent");
          messageInput.value = ""; // 입력창 비우기
        }
      }

      function WebSocketClose() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          console.log("WebSocket 연결 종료");
          ws.close();
        } else {
          addMessage("WebSocket이 이미 종료되었습니다.", "error");
        }
      }

      // 페이지 로드 시 자동으로 WebSocket 연결
      window.addEventListener("load", function () {
        connectWebSocket();
      });

      // Enter 키로 메시지 전송
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("message")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
      });
    </script>
  </body>
</html>
